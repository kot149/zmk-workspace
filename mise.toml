[tools]
python = "3.11"
cmake = "3.28"
ninja = "1.11"
"pipx:yq" = "latest"
"pipx:west" = "latest"
jq = "latest"
uv = "latest"
fzf = "latest"

[env]
_.python.venv = { path = ".venv", create = true }
ZMK_BUILD_DIR = "{{cwd}}/.build"
ZMK_SRC_DIR = "{{cwd}}/zmk/app"
CONFIG = "{{cwd}}/config"
BUILD = "{{cwd}}/.build"
OUT = "{{cwd}}/firmware"
DRAW = "{{cwd}}/draw"
ZEPHYR_BASE = "{{cwd}}/zephyr"
ZEPHYR_SDK_INSTALL_DIR = "{{cwd}}/.zephyr-sdk"

[settings.pipx]
uvx = true

[tasks.get-zmk-config-root]
description = "Get ZMK config root path from .west/config"
run = '''
#!/usr/bin/env bash
if [ -f .west/config ]; then
  path=$(awk -F ' *= *' '/^ *path/ {print $2}' .west/config)
  file=$(awk -F ' *= *' '/^ *file/ {print $2}' .west/config)
  west_yml_path="${path:-.}/${file}"
  realpath "$(dirname "$(dirname "$west_yml_path")")"
else
  realpath "."
fi
'''

[tasks.parse-targets]
description = "Parse build.yaml and filter targets by expression"
run = '''
#!/usr/bin/env bash
expr="${1:-all}"
zmk_config_root=$(mise run get-zmk-config-root)
attrs="[.board, .shield, .snippet, .\"artifact-name\"]"
filter="(($attrs | map(. // [.]) | combinations), ((.include // {})[] | $attrs)) | join(\",\")"
echo "$(yq -r "$filter" "$zmk_config_root/build.yaml" | grep -v "^," | grep -i "${expr/#all/.*}")"
'''

[tasks.build-single]
description = "Build firmware for single board & shield combination"
run = '''
#!/usr/bin/env bash
set -euo pipefail
board="$1"
shield="$2"
snippet="$3"
artifact="${4:-${shield:+${shield// /+}-}${board}}"
shift 4
west_args="$@"

artifact="${artifact:-${shield:+${shield// /+}-}${board}}"
build_dir="$BUILD/$artifact"
zmk_config_root=$(mise run get-zmk-config-root)

echo "Building firmware for $artifact..."

if [[ -f "$zmk_config_root/zephyr/module.yml" ]]; then
    west build -s zmk/app -d "$build_dir" -b $board ${west_args} ${snippet:+-S "$snippet"} -- \
        -DZMK_CONFIG="$zmk_config_root/config" -DZMK_EXTRA_MODULES="$zmk_config_root" ${shield:+-DSHIELD="$shield"}
else
    west build -s zmk/app -d "$build_dir" -b $board ${west_args} ${snippet:+-S "$snippet"} -- \
        -DZMK_CONFIG="$zmk_config_root/config" ${shield:+-DSHIELD="$shield"}
fi

if [[ -f "$build_dir/zephyr/zmk.uf2" ]]; then
    mkdir -p "$OUT" && cp "$build_dir/zephyr/zmk.uf2" "$OUT/$artifact.uf2"
else
    mkdir -p "$OUT" && cp "$build_dir/zephyr/zmk.bin" "$OUT/$artifact.bin"
fi
'''

[tasks.build]
description = "Build firmware for matching targets"
depends = []
run = '''
#!/usr/bin/env bash
set -euo pipefail
expr="${1:-all}"
shift || true
west_args="$@"

targets=$(mise run parse-targets "$expr")

[[ -z $targets ]] && echo "No matching targets found. Aborting..." >&2 && exit 1
echo "$targets" | while IFS=, read -r board shield snippet artifact; do
    mise run build-single "$board" "$shield" "$snippet" "$artifact" $west_args
done
'''

[tasks.clean]
description = "Clear build cache and artifacts"
run = '''
rm -rf "$BUILD" "$OUT"
'''

[tasks.clean-all]
description = "Clear all automatically generated files"
depends = ["clean"]
run = '''
rm -rf .west zmk
'''

[tasks.draw]
description = "Parse & plot keymap"
run = '''
#!/usr/bin/env bash
set -euo pipefail
keymap -c "$DRAW/config.yaml" parse -z "$CONFIG/base.keymap" --virtual-layers Combos >"$DRAW/base.yaml"
yq -Yi '.combos.[].l = ["Combos"]' "$DRAW/base.yaml"
keymap -c "$DRAW/config.yaml" draw "$DRAW/base.yaml" -k "ferris/sweep" >"$DRAW/base.svg"
'''

[tasks.setup-west-deps]
description = "Install Zephyr Python dependencies"
run = '''
uv pip install -r zephyr/scripts/requirements.txt
'''

[tasks.setup-zephyr-sdk]
description = "Download and install Zephyr SDK 0.16.3"
run = '''
mkdir -p .zephyr-sdk
cd .zephyr-sdk && curl -L https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.3/zephyr-sdk-0.16.3_linux-x86_64.tar.xz | tar -xJ --strip-components=1
./setup.sh -h
'''

[tasks.init]
description = "Initialize west"
run = '''
#!/usr/bin/env bash
set -euo pipefail

config_path="${1:-}"

if [[ -z "$config_path" ]]; then
    subdirs=$(find config -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)
    candidates=$(printf "config\n"; printf "%s\n" "$subdirs" | sed 's#^#config/#')

    config_path=$(echo "$candidates" | fzf \
        --prompt="Select ZMK config: " \
        --header="Choose a configuration to initialize" \
        --preview="ls -1a config/{}")

    if [[ -z "$config_path" ]]; then
        echo "No config selected. Exiting..."
        exit 0
    fi
fi

if [[ -f "$config_path/west.yml" ]]; then
    west_yml_abs="$config_path/west.yml"
else
    west_yml_abs="$config_path/config/west.yml"
fi

west_yml_rel=$(realpath --relative-to=config "$west_yml_abs")

rm -rf .west
west init -l config --mf "$west_yml_rel"
west update --fetch-opt=--filter=blob:none
west zephyr-export
'''

[tasks.setup]
description = "Complete ZMK development environment setup"
depends = ["setup-zephyr-sdk", "setup-west-deps"]
run = '''
echo "ZMK development environment setup complete!"
echo "ZEPHYR_BASE: $ZEPHYR_BASE"
echo "ZEPHYR_SDK_INSTALL_DIR: $ZEPHYR_SDK_INSTALL_DIR"
'''

[tasks.list]
description = "List build targets"
run = '''
mise run parse-targets all | sed 's/,*$//' | sort | column
'''

[tasks.update]
description = "Update west"
run = '''
west update --fetch-opt=--filter=blob:none
'''

[tasks.upgrade-sdk]
description = "Upgrade zephyr-sdk and python dependencies"
run = '''
echo !! This task is not implemented yet !!
# nix flake update --flake .
'''

[tasks.flash]
description = "Flash firmware for matching targets"
run = '''
#!/usr/bin/env bash
set -euo pipefail

# Check if -r option is provided
rebuild=false
build_args=()
expr="$1"
shift

for arg in "$@"; do
    if [[ "$arg" == "-r" ]]; then
        rebuild=true
    else
        build_args+=("$arg")
    fi
done

# Rebuild if -r option was provided
if [[ "$rebuild" == "true" ]]; then
    echo "Rebuilding before flashing..."
    mise run build "$expr" "${build_args[@]}"
fi

target=$(mise run parse-targets "$expr" | head -n 1)

if [[ -z "$target" ]]; then
    echo "No matching targets found for expression '$expr'. Aborting..." >&2
    exit 1
fi

IFS=, read -r board shield snippet artifact <<< "$target"
if [[ -n "$artifact" ]]; then
    artifact_name="$artifact"
else
    artifact_name="${shield:+${shield// /+}-}${board}"
fi
uf2_file="$artifact_name.uf2"
uf2_path="$OUT/$uf2_file"

if [[ ! -f "$uf2_path" ]]; then
    echo "Firmware file '$uf2_path' not found. Please build it first with 'mise run build \"$expr\"'." >&2
    exit 1
fi

echo "Flashing '$uf2_path'..."
win_build_dir=$(wslpath -w "$OUT")
powershell.exe -ExecutionPolicy Bypass -File flash.ps1 -BuildDir "$win_build_dir" -Uf2File "$uf2_file"
'''

[tasks.test]
description = "Run tests"
run = '''
#!/usr/bin/env bash
set -euo pipefail
testpath="$1"
shift
FLAGS="$@"

testcase=$(basename "$testpath")
build_dir="$BUILD/tests/$testcase"
config_dir="$(pwd)/$testpath"

if [[ "$FLAGS" != *"--no-build"* ]]; then
    echo "Running $testcase..."
    rm -rf "$build_dir"
    west build -s zmk/app -d "$build_dir" -b native_posix_64 -- \
        -DCONFIG_ASSERT=y -DZMK_CONFIG="$config_dir" \
        ${ZMK_EXTRA_MODULES:+-DZMK_EXTRA_MODULES="$(realpath ${ZMK_EXTRA_MODULES})"}
fi

${build_dir}/zephyr/zmk.exe | sed -e "s/.*> //" |
    tee ${build_dir}/keycode_events.full.log |
    sed -n -f ${config_dir}/events.patterns > ${build_dir}/keycode_events.log
if [[ "$FLAGS" == *"--verbose"* ]]; then
    cat ${build_dir}/keycode_events.log
fi

if [[ "$FLAGS" == *"--auto-accept"* ]]; then
    cp ${build_dir}/keycode_events.log ${config_dir}/keycode_events.snapshot
fi
diff -auZ ${config_dir}/keycode_events.snapshot ${build_dir}/keycode_events.log
'''
